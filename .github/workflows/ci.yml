# ============================================================
# CI Pipeline - Runs on every push and pull request
# ============================================================

name: CI Pipeline

# When to run this workflow
on:
  push:
    branches: 
      - main
      - develop
  pull_request:
    branches: 
      - main

# Jobs to run
jobs:
  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Lint and Check Code Quality
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: ğŸ” Lint Code
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Get the code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      # Step 3: Install linting tools
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black
      
      # Step 4: Run linter
      - name: Run Flake8 (Linter)
        run: |
          flake8 scripts/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 scripts/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      # Step 5: Check code formatting
      - name: Check Black formatting
        run: |
          black --check scripts/ --verbose || true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Run Unit Tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: lint  # Run after lint job passes
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pandas
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run tests
        run: |
          pytest tests/ -v --tb=short || echo "No tests found or tests failed"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Validate Data Files
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate-data:
    name: ğŸ“Š Validate Data
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install pandas
        run: pip install pandas
      
      - name: Validate CSV files
        run: |
          python << 'PYTHON_SCRIPT'
          import pandas as pd
          import sys
          
          files = {
              'data/sales_data.csv': ['order_id', 'customer_id', 'product_id'],
              'data/products.csv': ['product_id', 'product_name'],
              'data/customers.csv': ['customer_id', 'first_name']
          }
          
          errors = []
          for file, required_cols in files.items():
              try:
                  df = pd.read_csv(file)
                  print(f"âœ… {file}: {len(df)} rows")
                  
                  for col in required_cols:
                      if col not in df.columns:
                          errors.append(f"âŒ {file}: Missing column '{col}'")
                      else:
                          print(f"   âœ“ Column '{col}' exists")
                          
              except Exception as e:
                  errors.append(f"âŒ {file}: {str(e)}")
          
          if errors:
              print("\nâš ï¸ Validation Errors:")
              for e in errors:
                  print(e)
              sys.exit(1)
          else:
              print("\nâœ… All data files validated successfully!")
          PYTHON_SCRIPT

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 4: Security Scan
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for secrets
        run: |
          echo "Checking for potential secrets..."
          
          # Check for AWS keys
          if grep -r "AKIA" --include="*.py" --include="*.json" --include="*.yml" .; then
            echo "âŒ Potential AWS Access Key found!"
            exit 1
          fi
          
          # Check for passwords
          if grep -ri "password\s*=" --include="*.py" --include="*.json" . | grep -v ".gitignore"; then
            echo "âš ï¸ Potential password found (review manually)"
          fi
          
          echo "âœ… No obvious secrets found"
